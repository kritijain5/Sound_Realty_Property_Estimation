version: '3.8'

services:
  fastapi_app:
    build:
      context: .
      dockerfile: Dockerfile.fastapi
      args:
        API_VERSION: ${API_VERSION}
    image: kritij/fastapi-app:1.5.0
    ports:
      - "8000:8000"
    environment:
      - API_VERSION=${API_VERSION} # Pass to the running container
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      restart_policy:
        condition: on-failure

  streamlit_app:
    build:
      context: .
      dockerfile: Dockerfile.streamlit
      args:
        API_VERSION: ${API_VERSION}
    image: kritij/streamlit-app:1.5.0
    ports:
      - "8501:8501"
    environment:
      - API_VERSION=${API_VERSION}
    depends_on:
      - fastapi_app
    deploy:
      restart_policy:
        condition: on-failure
